<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Feedback - Cafe Caffeine</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="/css/feedback.css" />
  </head>
  <body>
    <!-- header section starts  -->
    <header class="header">
      <a href="/" class="logo"><img src="images/logo.png" alt="Logo" /></a>
      <nav class="navbar">
        <a href="/">home</a>
        <a href="/#about">about</a>
        <a href="menu">menu</a>
        <a href="feedback" style="color: var(--main-color)">feedback</a>
        <a href="/#contact">contact</a>
        <% if (name) { %>
        <a href="api/users/signout">Log Out</a>
        <% } else { %>
        <a href="signin">Sign In</a>
        <% } %>
      </nav>
    </header>
    <!-- header section ends -->

    <!-- Hero Section -->
    <br />
    <br />
    <br />
    <br />
    <br />
    <section class="feedback-hero">
      <div class="hero-content">
        <h1 class="hero-title">
          <i class="fas fa-heart"></i>
          Share Your Experience
        </h1>
        <p class="hero-subtitle">
          Your feedback helps us brew the perfect experience for everyone
        </p>
        <div class="hero-decoration">
          <i class="fas fa-coffee coffee-icon"></i>
          <div class="steam steam-1"></div>
          <div class="steam steam-2"></div>
          <div class="steam steam-3"></div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
      <div class="feedback-container">
        <!-- Feedback Form -->
        <div class="feedback-form-container">
          <div class="form-header">
            <h2 class="form-title">
              <i class="fas fa-star-half-alt"></i>
              Tell Us About Your Visit
            </h2>
            <p class="form-description">
              We value your opinion and would love to hear about your experience
              at Cafe Caffeine
              <br />
              <br />
            </p>
          </div>
          <form id="feedback-form" class="feedback-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="name" class="form-label">
                  <i class="fas fa-user"></i>
                  Full Name *
                </label>
                <div class="input-wrapper">
                  <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input"
                    placeholder="Enter your full name"
                    required
                  />
                  <div class="input-focus-line"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="email" class="form-label">
                  <i class="fas fa-envelope"></i>
                  Email Address *
                </label>
                <div class="input-wrapper">
                  <input
                    type="email"
                    id="email"
                    name="email"
                    class="form-input"
                    placeholder="Enter your email address"
                    required
                  />
                  <div class="input-focus-line"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="phone" class="form-label">
                  <i class="fas fa-phone"></i>
                  Phone Number
                </label>
                <div class="input-wrapper">
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    class="form-input"
                    placeholder="+1 (555) 123-4567"
                    pattern="^\+?\d{7,15}$"
                  />
                  <div class="input-focus-line"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="visitDate" class="form-label">
                  <i class="fas fa-calendar-alt"></i>
                  Date of Visit *
                </label>
                <div class="input-wrapper">
                  <input
                    type="date"
                    id="visitDate"
                    name="visitDate"
                    class="form-input"
                    required
                  />
                  <div class="input-focus-line"></div>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group recommendation-group">
                <label class="form-label">
                  <i class="fas fa-thumbs-up"></i>
                  Would you recommend us? *
                </label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input
                      type="radio"
                      name="recommend"
                      value="yes"
                      class="radio-input"
                      required
                    />
                    <span class="radio-custom"></span>
                    <span class="radio-text">
                      <i class="fas fa-heart"></i> Absolutely!
                    </span>
                  </label>
                  <label class="radio-label">
                    <input
                      type="radio"
                      name="recommend"
                      value="no"
                      class="radio-input"
                    />
                    <span class="radio-custom"></span>
                    <span class="radio-text">
                      <i class="fas fa-meh"></i> Not really
                    </span>
                  </label>
                </div>
              </div>

              <div class="form-group rating-group">
                <label class="form-label">
                  <i class="fas fa-star"></i>
                  Rate your experience *
                </label>
                <div class="rating-container">
                  <div class="stars-wrapper" id="ratingStars">
                    <span class="star" data-value="1">
                      <i class="fas fa-star"></i>
                    </span>
                    <span class="star" data-value="2">
                      <i class="fas fa-star"></i>
                    </span>
                    <span class="star" data-value="3">
                      <i class="fas fa-star"></i>
                    </span>
                    <span class="star" data-value="4">
                      <i class="fas fa-star"></i>
                    </span>
                    <span class="star" data-value="5">
                      <i class="fas fa-star"></i>
                    </span>
                  </div>
                  <div class="rating-text" id="ratingText">Click to rate</div>
                </div>
                <input type="hidden" id="rating" name="rating" required />
              </div>
            </div>

            <div class="form-group full-width">
              <label for="suggestion" class="form-label">
                <i class="fas fa-comment-dots"></i>
                Tell us more about your experience
              </label>
              <div class="textarea-wrapper">
                <textarea
                  id="suggestion"
                  name="suggestion"
                  maxlength="500"
                  rows="4"
                  class="form-textarea"
                  placeholder="Share your thoughts, suggestions, or what you loved most about your visit..."
                ></textarea>
                <div class="char-counter">
                  <span id="charCount">0</span> / 500 characters
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="submit-btn" id="submitBtn">
                <span class="btn-content">
                  <i class="fas fa-paper-plane"></i>
                  <span class="btn-text">Share Your Feedback</span>
                </span>
                <div class="btn-loading">
                  <i class="fas fa-spinner fa-spin"></i>
                  Submitting...
                </div>
              </button>
            </div>
          </form>

          <div class="feedback-messages">
            <div id="feedback-success" class="message success-message hidden">
              <i class="fas fa-check-circle"></i>
              <span>Thank you for your valuable feedback!</span>
            </div>
            <div id="feedback-error" class="message error-message hidden">
              <i class="fas fa-exclamation-triangle"></i>
              <span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Customer Testimonials Section -->
      <div class="testimonials-section">
        <div class="feedback-container">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-users"></i>
              What Our Customers Say
            </h2>
            <p class="section-subtitle">
              Real experiences from real coffee lovers
            </p>
          </div>

          <div id="feedback-list" class="testimonials-grid">
            <!-- Feedback items will be loaded here -->
          </div>

          <div class="no-feedback hidden" id="no-feedback">
            <i class="fas fa-comment-slash"></i>
            <h3>No feedback yet</h3>
            <p>Be the first to share your experience!</p>
          </div>
        </div>
      </div>
    </main>

    <!-- footer section begins  -->
    <section class="footer">
      <div class="share">
        <a href="#" class="fab fa-facebook-f"></a>
        <a href="#" class="fab fa-twitter"></a>
        <a href="#" class="fab fa-instagram"></a>
        <a href="#" class="fab fa-linkedin"></a>
        <a href="#" class="fab fa-pinterest"></a>
      </div>
      <div class="links">
        <a href="/">home</a>
        <a href="/#about">about</a>
        <a href="menu">menu</a>
        <a href="feedback">feedback</a>
        <a href="/#review">review</a>
        <a href="/#contact">contact</a>
      </div>

      <div class="credit">
        created by <span>Chahat</span>| all rights reserved
      </div>
    </section>

    <script>
      // Enhanced Star Rating System
      const stars = document.querySelectorAll(".star");
      const ratingInput = document.getElementById("rating");
      const ratingText = document.getElementById("ratingText");
      let currentRating = 0;

      const ratingTexts = {
        0: "Click to rate",
        1: "Poor - Disappointing experience",
        2: "Fair - Below expectations",
        3: "Good - Met expectations",
        4: "Very Good - Exceeded expectations",
        5: "Excellent - Outstanding experience!",
      };

      stars.forEach((star, index) => {
        // Click event
        star.addEventListener("click", () => {
          currentRating = parseInt(star.getAttribute("data-value"));
          ratingInput.value = currentRating;
          updateStarDisplay(currentRating);
          updateRatingText(currentRating);
        });

        // Hover effects
        star.addEventListener("mouseenter", () => {
          const hoverValue = parseInt(star.getAttribute("data-value"));
          updateStarDisplay(hoverValue);
          updateRatingText(hoverValue);
        });
      });

      // Reset stars on mouse leave
      document
        .querySelector(".stars-wrapper")
        .addEventListener("mouseleave", () => {
          updateStarDisplay(currentRating);
          updateRatingText(currentRating);
        });

      function updateStarDisplay(rating) {
        stars.forEach((star, index) => {
          const value = parseInt(star.getAttribute("data-value"));
          if (value <= rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });
      }

      function updateRatingText(rating) {
        ratingText.textContent = ratingTexts[rating];
      }

      // Enhanced Character Counter
      const suggestion = document.getElementById("suggestion");
      const charCount = document.getElementById("charCount");

      suggestion.addEventListener("input", () => {
        const length = suggestion.value.length;
        charCount.textContent = length;

        // Change color based on character count
        const counter = charCount.parentElement;
        if (length > 450) {
          counter.style.color = "var(--error-color)";
        } else if (length > 350) {
          counter.style.color = "var(--warning-color)";
        } else {
          counter.style.color = "var(--text-light)";
        }
      });

      // Enhanced Form Submission with Loading States
      const submitBtn = document.getElementById("submitBtn");
      const feedbackForm = document.getElementById("feedback-form");
      const successMessage = document.getElementById("feedback-success");
      const errorMessage = document.getElementById("feedback-error");

      feedbackForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Clear previous messages
        hideMessages();

        // Show loading state
        submitBtn.classList.add("loading");
        submitBtn.disabled = true;

        const formData = new FormData(feedbackForm);
        const data = {
          name: formData.get("name"),
          email: formData.get("email"),
          phone: formData.get("phone"),
          visitDate: formData.get("visitDate"),
          recommend: formData.get("recommend"),
          rating: formData.get("rating"),
          suggestion: formData.get("suggestion"),
        };

        // Validation
        if (!data.rating) {
          showError("Please provide a star rating.");
          resetSubmitButton();
          return;
        }

        if (!data.recommend) {
          showError("Please let us know if you would recommend us.");
          resetSubmitButton();
          return;
        }

        try {
          const response = await fetch("/api/users/feedbacks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const text = await response.text();
          const result = JSON.parse(text);

          if (response.ok) {
            // Success!
            showSuccess();
            resetForm();
            loadFeedbacks();

            // Auto-hide success message after 5 seconds
            setTimeout(() => {
              hideMessages();
            }, 5000);
          } else {
            showError(
              result.message || "Failed to submit feedback. Please try again."
            );
          }
        } catch (error) {
          console.error("Submission error:", error);
          showError(
            "An error occurred while submitting your feedback. Please try again."
          );
        } finally {
          resetSubmitButton();
        }
      });

      function resetSubmitButton() {
        submitBtn.classList.remove("loading");
        submitBtn.disabled = false;
      }

      function showSuccess() {
        successMessage.classList.remove("hidden");
      }

      function showError(message) {
        errorMessage.querySelector("span").textContent = message;
        errorMessage.classList.remove("hidden");
      }

      function hideMessages() {
        successMessage.classList.add("hidden");
        errorMessage.classList.add("hidden");
      }

      function resetForm() {
        feedbackForm.reset();
        currentRating = 0;
        ratingInput.value = "";
        updateStarDisplay(0);
        updateRatingText(0);
        charCount.textContent = "0";
        charCount.parentElement.style.color = "var(--text-light)";
      }

      // Enhanced Feedback Display
      async function loadFeedbacks() {
        try {
          const response = await fetch("/api/users/feedbacks", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          if (!response.ok) {
            throw new Error("Failed to fetch feedbacks");
          }

          const result = await response.json();
          displayFeedbacks(result.data || []);
        } catch (error) {
          console.error("Error loading feedbacks:", error);
          const feedbackList = document.getElementById("feedback-list");
          feedbackList.innerHTML = `
            <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Unable to load feedback at this time.</p>
            </div>
          `;
        }
      }

      function displayFeedbacks(feedbacks) {
        const feedbackList = document.getElementById("feedback-list");
        const noFeedback = document.getElementById("no-feedback");

        if (feedbacks.length === 0) {
          feedbackList.innerHTML = "";
          noFeedback.classList.remove("hidden");
          return;
        }

        noFeedback.classList.add("hidden");
        feedbackList.innerHTML = "";

        feedbacks.forEach((feedback) => {
          const feedbackCard = createFeedbackCard(feedback);
          feedbackList.appendChild(feedbackCard);
        });
      }

      function createFeedbackCard(feedback) {
        const card = document.createElement("div");
        card.className = "testimonial-card";

        const customerName =
          feedback.name || feedback.user?.email || "Anonymous";
        const initials = getInitials(customerName);
        const visitDate = new Date(feedback.visitDate).toLocaleDateString(
          "en-US",
          {
            year: "numeric",
            month: "long",
            day: "numeric",
          }
        );

        const createdDate = new Date(feedback.createdAt).toLocaleDateString(
          "en-US",
          {
            year: "numeric",
            month: "short",
            day: "numeric",
          }
        );

        const ratingStars = generateStars(feedback.rating);
        const recommendationBadge = generateRecommendationBadge(
          feedback.recommend
        );

        card.innerHTML = `
          <div class="customer-info">
            <div class="customer-avatar">${initials}</div>
            <div class="customer-details">
              <h4>${customerName}</h4>
              <div class="visit-date">Visited on ${visitDate}</div>
            </div>
          </div>
          
          <div class="testimonial-content">
            ${
              feedback.suggestion
                ? `
              <div class="testimonial-text">
                ${feedback.suggestion}
              </div>
            `
                : ""
            }
            
            <div class="rating-display">
              ${ratingStars}
            </div>
            
            ${recommendationBadge}
          </div>
          
          <div class="feedback-meta">
            <small>Shared on ${createdDate}</small>
          </div>
        `;

        // Add entrance animation
        card.style.opacity = "0";
        card.style.transform = "translateY(20px)";

        setTimeout(() => {
          card.style.transition = "all 0.5s ease";
          card.style.opacity = "1";
          card.style.transform = "translateY(0)";
        }, 100);

        return card;
      }

      function getInitials(name) {
        if (name.includes("@")) {
          // Email address
          return name.charAt(0).toUpperCase();
        }

        const words = name.trim().split(" ");
        if (words.length >= 2) {
          return (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
        }
        return words[0].charAt(0).toUpperCase();
      }

      function generateStars(rating) {
        let starsHTML = "";
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) {
            starsHTML += '<i class="fas fa-star star"></i>';
          } else {
            starsHTML +=
              '<i class="far fa-star star" style="color: var(--border-color);"></i>';
          }
        }
        return starsHTML;
      }

      function generateRecommendationBadge(recommend) {
        const isPositive = recommend === "yes";
        const badgeClass = isPositive ? "positive" : "negative";
        const icon = isPositive ? "fas fa-thumbs-up" : "fas fa-thumbs-down";
        const text = isPositive ? "Recommends us" : "Doesn't recommend";

        return `
          <div class="recommendation-badge ${badgeClass}">
            <i class="${icon}"></i>
            <span>${text}</span>
          </div>
        `;
      }

      // Load feedbacks when page loads
      document.addEventListener("DOMContentLoaded", () => {
        loadFeedbacks();

        // Add some interactive enhancements
        enhanceFormExperience();
      });

      function enhanceFormExperience() {
        // Add floating label effect to inputs
        const inputs = document.querySelectorAll(".form-input, .form-textarea");

        inputs.forEach((input) => {
          input.addEventListener("focus", () => {
            input.parentElement.classList.add("focused");
          });

          input.addEventListener("blur", () => {
            if (!input.value) {
              input.parentElement.classList.remove("focused");
            }
          });
        });

        // Add smooth scrolling to form after hero section
        const heroSection = document.querySelector(".feedback-hero");
        if (heroSection) {
          setTimeout(() => {
            const formSection = document.querySelector(
              ".feedback-form-container"
            );
            if (formSection) {
              formSection.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          }, 1000);
        }
      }
    </script>
  </body>
</html>
